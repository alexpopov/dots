#!/bin/bash
# git-ls: List commits since branch point with diff# and task#
#
# Shows commits from find-split to HEAD with phabricator diff and task numbers

set -euo pipefail

# Early exit if not in a git repo
if ! git rev-parse --git-dir &>/dev/null; then
    echo "fatal: not a git repository" >&2
    exit 1
fi

# Get the split point
split=$(git find-split) || exit 1

# Extract diff number from commit message (e.g., D12345678)
get_diff_number() {
    git log -1 --format=%B "$1" 2>/dev/null | awk '/phab/ { n = split($0, A, "/"); print A[n]; exit }'
}

# Extract task number from commit message (e.g., T12345678)
get_task_number() {
    git log -1 --format=%B "$1" 2>/dev/null | awk '/Tasks:/ { print $2; exit }'
}

# List commits from split to HEAD
git rev-list "${split}^..HEAD" | while read -r sha1; do
    diff_num=$(get_diff_number "$sha1")
    task_num=$(get_task_number "$sha1")
    git --no-pager show -s \
        --pretty="%C(auto)%h %d %C(auto)%s %C(bold) ${diff_num}  ${task_num}%C(reset)" \
        "$sha1"
done
